venv\Scripts\python : 2026-01-14 16:09:02,613 - memobase_server - INFO - Us
er profiles: 
At line:1 char:1
+ venv\Scripts\python -m pytest -s -vv -o log_cli=true tests/test_chat_ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (2026-01-14 16:0...User profil 
   es: :String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
- basic_info ()
  - name
  - age(integer)
  - gender
  - birth_date
  - nationality
  - ethnicity
  - language_spoken
- contact_info ()
  - email
  - phone
  - city
  - country
- education ()
  - school
  - degree
  - major
- demographics ()
  - marital_status
  - number_of_children
  - household_income
- work ()
  - company
  - title
  - working_industry
  - previous_projects
  - work_skills
- interest ()
  - books
  - movies
  - music
  - foods
  - sports
- psychological ()
  - personality
  - values
  - beliefs
  - motivations
  - goals
- life_event ()
  - marriage
  - relocation
  - retirement
...
2026-01-14 16:09:03,341 - app - INFO - Logging configuration refreshed and 
loggers resurrected.
============================= test session starts =============================
platform win32 -- Python 3.11.5, pytest-9.0.2, pluggy-1.6.0 -- E:\workspace\code\DouDouChat\server\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: E:\workspace\code\DouDouChat\server
plugins: anyio-4.12.0, asyncio-1.3.0, typeguard-4.4.4
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

2026-01-14 16:09:03,420 - app - INFO - Logging configuration refreshed and 
loggers resurrected.
2026-01-14 16:09:03,421 - app.db.init_db - INFO - Running Alembic migration
s for [main]...
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
2026-01-14 16:09:03,481 - app - INFO - Logging configuration refreshed and 
loggers resurrected.
2026-01-14 16:09:03,481 - app.main - INFO - Application startup complete. L
ogging system is active.
2026-01-14 16:09:03,482 - memobase_server - INFO - {"project_id": "default"
, "user_id": "system"} | Memobase background worker started
2026-01-14 16:09:03,485 - app.main - INFO - Starting session archiver backg
round task...
2026-01-14 16:09:03,495 - httpx - INFO - HTTP Request: POST http://testserv
er/api/friends/ "HTTP/1.1 200 OK"
2026-01-14 16:09:03,501 - httpx - INFO - HTTP Request: POST http://testserv
er/api/chat/sessions "HTTP/1.1 200 OK"
2026-01-14 16:09:03,514 - app.services.chat_service - INFO - [GenTask] Star
ting generation for Session 1, AI Msg 2
2026-01-14 16:09:03,521 - app.services.chat_service - ERROR - [GenTask] Err
or: 'NoneType' object has no attribute 'strip'
Traceback (most recent call last):
  File "E:\workspace\code\DouDouChat\server\app\services\chat_service.py", 
line 581, in _run_chat_generation_task
    persona_prompt = (friend.system_prompt if friend else get_prompt("chat/
default_system_prompt.txt")).strip()
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'strip'
2026-01-14 16:09:03,522 - httpx - INFO - HTTP Request: POST http://testserv
er/api/chat/sessions/1/messages "HTTP/1.1 200 OK"
tests/test_chat_persistence.py::test_chat_persistence_after_disconnect Simulated client disconnect...
Verified Database content: ''
2026-01-14 16:09:04,716 - memobase_server - INFO - {"project_id": "default"
, "user_id": "system"} | Memobase background worker is stopping...
FAILED

================================== FAILURES ===================================
___________________ test_chat_persistence_after_disconnect ____________________

client = <starlette.testclient.TestClient object at 0x00000253067E7110>
db = <sqlalchemy.orm.session.Session object at 0x000002530606A050>

    @pytest.mark.asyncio
    async def test_chat_persistence_after_disconnect(client, db):
        """
        测试：即便前端中途断开 SSE 连接，后端仍能完成 LLM 回复的生成并持久化到数据库。
        """
        # 0. 设置 Mock LLM 配置
        llm_config = LLMConfig(
            base_url="https://mock.url",
            api_key="mock_key",
            model_name="mock-model"
        )
        db.add(llm_config)
        db.commit()
    
        # 1. 创建好友和会话
        friend_data = {"name": "Assistant", "is_preset": False}
        response = client.post("/api/friends/", json=friend_data)
        friend_id = response.json()["id"]
    
        response = client.post("/api/chat/sessions", json={"friend_id": friend_id})
        session_id = response.json()["id"]
    
        # 2. 模拟一个较长的流式回复
        async def mock_stream_events():
            chunks = ["This ", "is ", "a ", "persisted ", "response."]
            for i, chunk in enumerate(chunks):
                await asyncio.sleep(0.05)
                yield create_mock_event(chunk, i)
    
        mock_runner_result = MagicMock()
        mock_runner_result.stream_events = mock_stream_events
    
        # Patch SessionLocal 为指向测试用的 engine 的 sessionmaker
        MockSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    
        # Mock 外部服务以防阻塞
        mock_recall_func = AsyncMock(return_value={"injected_messages": [], "footprints": []})
        mock_memo_func = AsyncMock(return_value=MagicMock(profiles=[]))
    
        with patch("app.services.chat_service.Runner.run_streamed", return_value=mock_runner_result), \
             patch("app.services.chat_service.SessionLocal", MockSessionLocal), \
             patch("app.services.chat_service.RecallService.perform_recall", mock_recall_func), \
             patch("app.services.chat_service.MemoService.get_user_profiles", mock_memo_func), \
             patch("app.services.chat_service.AsyncOpenAI", return_value=MagicMock()):
    
            # 3. 发送消息并故意中途断开
            msg_data = {"content": "Hello, stay alive!"}
    
            # TestClient.stream 是同步的，但在内部它会处理应用逻辑。
            # 我们模拟快速断开的过程。
            with client.stream("POST", f"/api/chat/sessions/{session_id}/messages", json=msg_data) as response:
                assert response.status_code == 200
    
                # 我们只读一个 event 就断开
                it = response.iter_lines()
                next(it) # event: start
                next(it) # data: {...}
                print("Simulated client disconnect...")
    
            # 4. 关键：等待异步后台任务跑完
            # 因为任务是 asyncio.create_task 发起的，它会在同一个事件循环运行。
            # 我们需要 await 一个异步挂起的操作，让出控制权给任务。
            await asyncio.sleep(0.5)
    
            # 5. 验证数据库
            db.expire_all()
            messages = db.query(Message).filter(Message.session_id == session_id, Message.role == "assistant").all()
    
            assert len(messages) == 1
            ai_msg = messages[0]
            expected_content = "This is a persisted response."
    
            print(f"Verified Database content: '{ai_msg.content}'")
>           assert ai_msg.content == expected_content
E           AssertionError: assert '' == 'This is a persisted response.'
E             
E             - This is a persisted response.

tests\test_chat_persistence.py:102: AssertionError
============================== warnings summary ===============================
app\core\config.py:11
  E:\workspace\code\DouDouChat\server\app\core\config.py:11: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

app\schemas\chat.py:15
  E:\workspace\code\DouDouChat\server\app\schemas\chat.py:15: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class MessageRead(MessageBase):

app\schemas\chat.py:36
  E:\workspace\code\DouDouChat\server\app\schemas\chat.py:36: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ChatSessionRead(ChatSessionBase):

app\schemas\system_setting.py:19
  E:\workspace\code\DouDouChat\server\app\schemas\system_setting.py:19: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SystemSetting(SystemSettingBase):

tests/test_chat_persistence.py::test_chat_persistence_after_disconnect
  E:\workspace\code\DouDouChat\server\venv\Lib\site-packages\alembic\config.py:598: DeprecationWarning: No path_separator found in configuration; falling back to legacy splitting on spaces, commas, and colons for prepend_sys_path.  Consider adding path_separator=os to Alembic config.
    util.warn_deprecated(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_chat_persistence.py::test_chat_persistence_after_disconnect - AssertionError: assert '' == 'This is a persisted response.'
  
  - This is a persisted response.
======================== 1 failed, 5 warnings in 1.33s ========================
