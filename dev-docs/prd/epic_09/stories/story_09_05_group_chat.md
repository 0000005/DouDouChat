# Story 09-05: 群聊消息服务接口 (API & SSE)

> Epic: AI 多人群聊 (Group Chat)
> Priority: High
> Points: 5

## 概述
定义并实现群聊消息的核心通信协议。扩展现有的后端 API 和 SSE 事件流，使其能够支持群组维度的消息发送、历史记录拉取以及多角色并发的消息推送。

## 用户故事

### US-1: 群消息发送与路由
**作为** 用户，
**我希望** 我的消息能准确发送到指定的群组，并触发对应的 Agent 调度，
**以便** 与群成员进行互动。

### US-2: 多角色并发推送
**作为** 系统，
**我希望** 通过 SSE 事件流同时向前端推送多个 Agent 的生成状态（思考中、消息片段、完成），
**以便** 支撑前端的并行渲染需求。

## 功能范围

### 包含
- **发送群消息接口**: `POST /api/chat/group` 接口开发，接收群 ID、文本内容、提及列表（mentions）。
- **历史记录获取接口**: 支持分页拉取群聊历史消息，包含发送者身份区分（Member ID）。
- **SSE 协议扩展**: 在 SSE 事件中增加 `sender_id` 和 `is_group` 标识，允许前端区分同一会话下的不同发送源。
- **并发任务管理**: 后端接收群消息后，开启异步任务池（Background Tasks）并发驱动多个 Agent。

### 不包含（后续迭代）
- 消息撤回 API
- 消息置顶/回复（引用）API

## 验收标准

- [ ] AC-1: 开发完成 `POST /api/chat/group` 接口，能成功将用户消息写入 `GroupMessage` 表。
- [ ] AC-2: SSE 流在推送 `start`, `thinking`, `message`, `done` 事件时，均携带正确的 `sender_id`。
- [ ] AC-3: 前端能够通过新的接口拉取到完整的群聊历史，消息顺序与时间戳一致。
- [ ] AC-4: 后端能同时处理来自同一群组消息驱动的多个异步 Agent 任务，互不干扰。
- [ ] AC-5: 异常处理：当目标群组不存在或用户不在群内时，接口返回 403/404 及对应的错误提示。

## 依赖关系

### 前置依赖
- Story 09-01: 群聊数据建模
- Story 09-02: 群组管理服务端接口 (API)

### 被依赖（后续）
- Story 09-04: @提及功能与强制触发
- Story 09-06: 群聊上下文适配
- Story 09-07: GroupChatArea 并行渲染
- Story 09-08: 隐藏的群管理员 Agent 实现
