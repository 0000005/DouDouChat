# Story 09-06: 群聊上下文适配 (Mock Tool Call)

> Epic: AI 多人群聊 (Group Chat)
> Priority: High
> Points: 5

## 概述
实现一种"上帝视角"式的上下文注入机制。通过伪造函数调用（Mock Tool Call），将群聊中其他成员的近期发言作为"外部观测数据"提供给当前发言的 Agent，使其具备感知全局、精准互动的能力，同时避免消息归属混淆。

## 用户故事

### US-1: 上下文感知
**作为** 开发中的 AI 好友，
**我希望** 能够通过某种结构化的方式看到群里其他角色刚才说了什么，
**以便** 产生连贯的社交回应，而不是各说各话。

### US-2: 角色区分
**作为** AI 模型，
**我希望** 群动态信息以"外部工具返回"的形式呈现，
**以便** 明确区分这是"背景观察"而非"用户对我的直接指令"。

## 功能范围

### 包含
- **群消息聚合**: 收集当前群组内最近的 N 条（如 10 条）非当前 Agent 的消息内容。
- **Mock Tool 协议实现**: 构造符合 OpenAI 定义的 Tool Call/Result 格式消息。
- **Tool 注入逻辑**: 在调用 LLM 接口前，自动将这些虚拟的对话历史插入到对话窗口中。
- **专用 Prompt 模板**: 在 `server/app/prompt/chat/` 下创建模板，引导模型如何利用 Tool 返回的群背景信息。

### 不包含（后续迭代）
- 长期记忆 RAG 在群聊中的复杂召回（初期仅考虑窗口内的短期消息注入）
- AI 主动发起该 Tool 的逻辑（目前仅为自动注入）

## 验收标准

- [ ] AC-1: 实现了 `get_other_members_messages` 虚拟工具及其对应的内容生成逻辑。
- [ ] AC-2: 在后端日志中确认 AI 收到的 Context 中包含格式化的 Tool Result 消息。
- [ ] AC-3: AI 能够识别并回应其他成员 in the 群内的发言（例如："刚才 A 提到的那个很有趣..."）。
- [ ] AC-4: 这种 Mock 逻辑不影响前端展示，前端接收到的消息流依然是纯净的。
- [ ] AC-5: 极端情况处理：当群内没有其他消息时，不注入无效的空 Tool Call。

## 依赖关系

### 前置依赖
- Story 09-01: 群聊数据建模
- Story 09-05: 群聊消息服务接口 (API & SSE)

### 被依赖（后续）
- Story 09-08: 隐藏的群管理员 Agent 实现
