# Epic 09: AI 多人群聊 (Group Chat)

## Epic 信息
- **Epic 编号**: Epic-09
- **Epic 名称**: AI 多人群聊 (Group Chat)
- **创建日期**: 2026-01-23
- **优先级**: High

## 业务目标

1. **模拟真实社交沙盒**：在单一的 1-to-1 对话基础上，扩展出多 Agent 互动的"群聊"场景。这不仅增加了用户的使用乐趣，还通过 Agent 之间的碰撞产生出意想不到的社交动态。
2. **解决调度与秩序问题**：引入“隐藏的群管理员Agent”（Hidden Admin），解决在没有固定轮询机制的情况下，多个 AI 角色如何有序发言、如何协同完成对话的难题。
3. **沉浸式上下文感知**：通过将群成员消息封装为"外部信息"（如 Mock Tool Call），使 AI 具备观察全局的能力，产生更自然的交互。

## 范围描述

### 包含内容
- **群聊管理基础**：群组的新建、成员管理（邀请/移出）、群基本信息设置（名称、描述、头像）。
- **隐藏的群管理员Agent (Hidden Admin)**：引入一个隐含的智能体，负责决定接收到用户消息后，哪些 AI 成员应该发言。
- **会话管理**：支持**手动新建会话**与**定时被动新建会话**的混合模式。
- **严格轮次控制**：核心交互规则——用户发送消息后，**必须等待**所有被调度（或被 @）的 AI 好友完成回复后，才能再次发送消息。
- **上下文感知机制**：AI 成员能够通过特定的 Prompt Template 或 Tool Call 参数，感知群内其他成员的近期发言内容。
- **特殊触发规则**：支持 @ 提及触发强制发言。若用户同时 @ 多个 AI，则这些 AI **并行**生成回复。
- **回复模式切换**：支持在群设置中开启/关闭“自动回复”。关闭后，隐藏管理员停止主动调度，AI 仅在被 @ 时发言。
- **群聊记忆系统**：支持群会话的定时自动归档，并**专门提取与用户相关**的宏观记忆片段（偏重用户画像更新，而非 Agent 间的琐事）。

### 不包含内容
- **图片能力**：不涉及图片发送、识别或生成功能。
- **音视频能力**：不含音频、视频通话或语音转文字功能。
- **复杂群协作工具**：如日程表、投票（仅限 AI 参与的基础投票除外）、群文件管理等。
- **第三方集成**：如接入真实的微信、钉钉等外部 IM 平台。

## 技术约束与常量
- **MAX_GROUP_MEMBERS**: 每个群组最多支持 20 名成员（含用户）。
- **MAX_PARALLEL_AGENTS**: 单次消息最多触发 3 个 Agent 并行回复，避免消息过载。
- **AUTO_REPLY_DEFAULT**: 群组创建时，自动回复模式默认为 **开启 (True)**。
- **MESSAGE_PREVIEW_FORMAT**: 侧边栏预览格式为 `[发送者名称]: 消息内容`。
- **FALLBACK_STRATEGY**: 若 Hidden Admin 调度失败或超时，默认回退为由群内活跃度最高或随机一名 Agent 回复。

## 用户旅程

```
用户点击"发起群聊" → 在好友列表中勾选多个 AI 好友 → 设置群聊名称 → 进入群聊窗口发送消息 → 
Manager 接收并分析消息 → 决定角色 A 与 B 需要发言 → **并行调度**角色 A 与 B → 
前端收到角色 A 的思考中状态 → 前端收到角色 B 的思考中状态 → 
角色 A 生成完毕，推送完整消息 → 角色 B 生成完毕，推送完整消息 → 
用户看到多条消息陆续弹出（非流式） → 交互结束，解除发送锁定。
```

## Story 拆分建议

| Story | 描述 | 优先级 |
|-------|------|--------|
| Story 09-01 | **群聊数据建模**：设计 Group, GroupMember, GroupMessage 表结构及迁移 | High |
| Story 09-02 | **群组管理服务端接口 (API)**：提供群组创建、成员管理及设置持久化接口 | High |
| Story 09-03 | **群组管理界面开发 (UI)**：实现仿微信的好友选择器、群设置页面及侧边栏预览 | High |
| Story 09-04 | **@功能与提及侦测**：实现前端 UI 提示 @ 功能及输入框联想菜单 | High |
| Story 09-05 | **群聊消息服务接口 (API & SSE)**：定义群消息发送、历史拉取及 SSE 协议扩展（多 Sender 支持） | High |
| Story 09-06 | **群聊上下文适配**：实现成员间消息的封装逻辑（Mock Tool Call），使 AI 感知群动态 | High |
| Story 09-07 | **GroupChatArea 并行渲染**：前端支持并行接收并展示多个 Agent 的输入状态与完整消息 | High |
| Story 09-08 | **隐藏的群管理员实现**：后端 Manager Agent 的逻辑开发、调度清单生成及错误兜底 | High |
| Story 09-09 | **自动回复逻辑门控**：在群设置中实现“自动回复”开关，关闭时仅支持 @ 触发回复 | Medium |
| Story 09-10 | **群聊输入状态优化**：移除顶部状态，并在聊天区底部显示具体发言人(XXX正在输入) | Medium |
| Story 09-11 | **定向记忆提取与提示词优化**：实现群聊专属归档逻辑，重点提取用户画像 | Medium |

## 技术约束（可选）
- **Prompt 管理**：所有调度逻辑与上下文封装模板必须存放在 `server/app/prompt/chat/` 下。
- **上下文注入 (Mock Tool)**：严禁直接拼接上下文文本。**必须伪造 Function Tool 调用** (如 `get_other_members_messages`)，将其他群成员的消息封装在 Tool Output 中传给 LLM。这样能最好地让 AI 理解“这是即时发生的群聊背景”而非“这是用户发给我的话”。
- **记忆提取 Prompt 隔离**：群聊记忆提取方案**必须与单聊隔离**。需设计专门的 `group_memory_extraction.txt` 提示词，聚焦于从混乱的多人对话中识别并提取对“用户”有价值的信息。
- **并行调度**：Manager 决策后，系统应**并行调用**所有被选中的 AI 角色进行生成，而非串行排队。
- **消息呈现**：**禁用流式打字机效果**。采用“异步完整消息”模式（类似真实微信体验），即 Agent 在后台生成时显示“对方正在输入...”，生成完毕后一次性将完整气泡推送到前端。
- **状态同步**：后端需维护群聊的“忙碌状态”，直到所有被调度的 Agent 都完成生成才释放锁，允许下一轮交互。
- **发送锁**：前端需实现全局发送锁，监听 Manager 的调度状态，只有当所有 Pending Agents 完成回复后才解锁 Input 框。
- **组件分离**：群聊**不复用** `ChatArea.vue`，而是新建 `GroupChatArea.vue`。通过抽取公共子组件（如 `MessageBubble`、`ChatInput`）实现代码复用，避免单一组件承载过多分支逻辑。单聊与群聊的业务差异过大（多发送者、并行消息、@ 功能），强行复用会导致维护成本激增。

## 依赖关系

### 前置依赖
- Epic-01: 基础聊天界面 (核心 SSE 协议与消息展示组件)

