# 记忆召回增强 LLM 回复 (Memory Recall Enhancement)

## 1. 需求背景

在 WeAgentChat 中，我们已经实现了"被动会话归档"机制，将用户与 AI 好友的聊天自动转化为长期记忆存储（Profile + Event Gists）。然而，这些记忆目前仅被存储，并未在后续对话中被有效利用。

为了让 AI 好友真正具备"记住你"的能力，需要在每次 LLM 回复前，**主动调用记忆服务（MCP）** 获取相关记忆，并将其作为上下文注入对话，从而实现更加个性化、有温度的对话体验。

## 2. 用户故事

### Story 1: 作为用户，我希望 AI 好友能记住我之前说过的事
**场景**：
> 用户（1月6日）：最近睡眠不好，有点焦虑
> 
> *（系统在后台主动调用 MCP，召回相关记忆）*
> *（召回结果：1月2日用户提到工作压力大，1月4日用户说最近熬夜多）*
> 
> AI 好友：睡眠问题确实会影响情绪。你之前提到项目汇报压力挺大的，准备得怎么样了？如果太累的话，适当放松一下吧。

**验收标准**：
- AI 回复中自然地引用了过往对话中的信息。
- 用户无需重复说明背景，AI 已经"记得"。

### Story 2: 作为用户，我希望 AI 好友了解我的个人偏好
**场景**：
> 用户：推荐个电影吧
> 
> *（系统主动调用 MCP，召回用户 Profile）*
> *（召回结果：用户喜欢科幻和悬疑类型，不喜欢恐怖片）*
> 
> AI 好友：知道你喜欢科幻，最近《沙丘2》口碑不错，要不要试试？

**验收标准**：
- AI 能基于用户画像给出个性化建议。
- 无需用户反复说明自己的偏好。

### Story 3: 作为系统，记忆召回应该只限于当前好友（隐私边界）
**场景**：
> 用户与"小助手"聊过失恋的事，与"职场导师"聊天时，"职场导师"的记忆召回不应该检索到"小助手"那边的失恋话题。

**验收标准**：
- 每个 AI 好友只能访问用户与 **自己** 的历史记忆（Event Gists）。
- 通过 `friend_id` 标签严格隔离对话历史。

## 3. 核心设计

### 3.1 记忆召回机制（两阶段架构）

#### 阶段一：回忆 Agent 独立执行
- **触发点**：每次用户发送消息时，在调用主对话 LLM 之前。
- **执行方式**：启动一个独立的**回忆 Agent**，专门负责搜索和整理相关记忆。
- **多步骤召回**：回忆 Agent 可以进行多轮思考和搜索（如：先搜 Profile，再根据结果决定是否深入搜索 Event Gists），确保找到最相关的记忆。搜索轮数可在**记忆设置**中配置。
- **独立原因**：将回忆逻辑与主对话逻辑解耦，回忆过程更智能、更可控。

#### 阶段二：模拟 MCP 调用，嵌入对话链
- **格式化输出**：回忆 Agent 完成后，将召回结果包装成标准的 **MCP 工具调用格式**（tool_call + tool_result）。
- **嵌入对话历史**：将这个"模拟的工具调用"作为对话历史的一部分，传递给主对话 Agent。
- **对话链效果**：主对话 Agent 看到的上下文中，会包含一个完整的 `recall_memory` 工具调用及其返回结果，仿佛它"自己"调用了记忆工具。

#### 设计优势
1. **可靠性**：不依赖主 LLM 被动决定是否调用工具（LLM 工具调用不是 100% 可靠）。
2. **智能性**：回忆 Agent 可以多步推理，找到更精准的记忆。
3. **一致性**：主对话 Agent 的上下文保持标准的工具调用链格式，无需特殊处理。
4. **可扩展**：未来可以让回忆 Agent 支持更复杂的记忆检索策略。

### 3.2 记忆召回范围与隐私
采用 **好友隔离** 策略：
- **Profile（用户画像）**：全局共享。反映用户的基本属性、偏好等，对所有 AI 好友可见。
- **Event Gists（事件摘要）**：按 `friend_id` 隔离。记录用户与特定好友的对话事件，仅在该好友的对话中可见。

### 3.3 记忆注入方式
- 将召回的记忆格式化为结构化文本。
- 注入到 LLM 的 **System Prompt** 中（作为"关于用户的背景信息"部分）。

## 4. MCP 工具定义：recall_memory

| 属性 | 值 |
| :--- | :--- |
| **工具名称** | `recall_memory` |
| **功能描述** | 根据当前对话内容，语义搜索相关的用户记忆（包含 Profile 和 Event Gists）。 |
| **调用时机** | 每次用户发送消息时，系统后台主动调用。 |

### 4.1 输入参数

| 参数名 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| `query` | string | 是 | 搜索关键词或当前用户消息内容。 |
| `friend_id` | int | 是 | 当前对话的 AI 好友 ID（用于 Event Gists 隔离）。 |
| `profile_topk` | int | 否 | Profile 返回的最大条数，默认 5。 |
| `event_topk` | int | 否 | Event Gist 返回的最大条数，默认 5。 |
| `similarity_threshold` | float | 否 | 语义相似度阈值，默认 0.5。 |

### 4.2 输出结构示例

```json
{
  "profiles": [
    {
      "topic": "职业",
      "content": "互联网公司产品经理",
      "updated_at": "2026-01-05"
    },
    {
      "topic": "兴趣",
      "content": "喜欢科幻电影和悬疑小说",
      "updated_at": "2026-01-03"
    }
  ],
  "events": [
    {
      "date": "2026-01-02",
      "content": "用户提到工作压力大，正在准备重要项目汇报"
    },
    {
      "date": "2026-01-04",
      "content": "用户说最近熬夜较多，担心影响工作状态"
    }
  ]
}
```

## 5. 前端设置

### 5.1 记忆设置（Memory Settings）

在设置对话框的"记忆设置"选项卡中，增加以下配置项：

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| 启用记忆召回 | Toggle | 开启 | 是否在对话前自动召回相关记忆 |
| 回忆搜索轮数 | Number (1-5) | 3 | 回忆 Agent 最多执行几轮搜索 |
| Profile 召回数量 | Number (1-10) | 5 | 每次召回的 Profile 条目上限 |
| Event 召回数量 | Number (1-10) | 5 | 每次召回的 Event Gist 条目上限 |
| 相似度阈值 | Slider (0-1) | 0.5 | 语义相似度的最低阈值 |

### 5.2 聊天设置（Chat Settings）

在设置对话框的"聊天设置"选项卡中，增加以下配置项：

| 配置项 | 类型 | 默认值 | 说明 |
| :--- | :--- | :--- | :--- |
| 显示工具调用 | Toggle | 关闭 | 是否在聊天界面展示工具调用过程（包括记忆召回） |
| 显示思维链 | Toggle | 关闭 | 是否展示 AI 的思考过程（如 `<think>` 内容） |

**说明**：
- 记忆召回被抽象为标准的 MCP 工具调用（`recall_memory`），与其他工具（如搜索、计算等）统一管理和展示。
- 当"显示工具调用"开启时，用户可以看到 AI 调用了 `recall_memory` 工具以及返回的记忆内容。
- 当"显示思维链"开启时，用户可以看到回忆 Agent 的多步推理过程。

## 6. 边界情况与注意事项

1. **空记忆处理**：如果没有召回任何记忆，不修改上下文，保持正常对话。
2. **记忆过长截断**：召回内容超过 token 限制时，需按相关度或时间顺序精选。
3. **性能控制**：记忆召回是同步阻塞 LLM 调用的过程，需控制超时（建议 < 3 秒）。
4. **新用户/新好友**：初期没有记忆时，系统应平滑回退到普通对话模式。
5. **搜索轮数限制**：回忆 Agent 达到配置的最大搜索轮数后，即使未找到理想结果也会结束。

## 7. 开发任务拆分

1. **MemoService 扩展**：
   - 实现 Profile 的语义搜索功能（目前仅支持全量获取）。
   - 实现 Event Gist 的复合查询（语义相关性 + `friend_id` 标签过滤）。
2. **回忆 Agent 开发**：
   - 实现独立的回忆 Agent，支持多轮搜索。
   - 支持可配置的最大搜索轮数。
3. **MCP 工具封装**：
   - 封装 `recall_memory` 工具接口。
   - 实现回忆结果到标准 tool_call 格式的转换。
4. **Chat Service 集成**：
   - 在 `send_message_stream` 中插入回忆 Agent 调用环节。
   - 将模拟的工具调用嵌入对话历史。
5. **配置中心扩展**：
   - 在 `system_settings` 中增加记忆设置相关参数（搜索轮数、TopK、阈值等）。
   - 在 `system_settings` 中增加聊天设置相关参数（显示工具调用、显示思维链）。
6. **前端设置界面**：
   - "记忆设置"选项卡：增加回忆相关配置。
   - "聊天设置"选项卡：增加工具调用和思维链展示开关。
7. **聊天界面适配**：
   - 支持根据配置展示/隐藏工具调用过程。
   - 支持根据配置展示/隐藏思维链内容。
